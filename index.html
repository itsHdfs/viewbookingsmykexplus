<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyKualaExpress+ View & Scan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<style>
body{margin:0;padding:0;font-family:'Inter',sans-serif;background:#111;color:#fff;}
header,footer{text-align:center;color:#d4af37;font-weight:700;padding:10px;}
h2{text-align:center;color:#d4af37;}
button,input{font-family:'Inter',sans-serif;}
.container{
  display:none;
  padding:30px;
  max-width:500px;
  margin:50px auto;
  background:#1a1a1a;
  border-radius:20px;
  box-shadow: 0 0 20px #d4af37, 0 0 40px #d4af37 inset, 0 0 60px #fff inset;
  transition:0.3s;
}
input{width:95%;padding:10px;margin:8px 0;border-radius:12px;border:2px solid #d4af37;background:#222;color:#fff;}
button{width:100%;padding:15px;margin-top:10px;border-radius:12px;border:none;background:linear-gradient(90deg,#d4af37,#a8b77e);color:#111;font-weight:700;cursor:pointer;transition:0.2s;}
button:hover{transform:translateY(-2px);}
#bookingDetails p{margin:6px 0;text-shadow:0 0 5px #d4af37;}

/* Loading Screen */
#loading{
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  background:#111;
  z-index:9999;
  display:flex; justify-content:center; align-items:center; flex-direction:column;
}
.loaderBadge{
  position:relative;
  width:100px; height:100px;
  border-radius:15px;
  background:#1a1a1a;
  overflow:hidden;
}
.loaderShimmer{
  position:absolute;
  inset:-50%;
  background:conic-gradient(from 0deg,
    rgba(212,175,55,0) 0%,
    rgba(212,175,55,0.35) 25%,
    rgba(255,255,255,0.15) 40%,
    rgba(191,163,111,0) 60%,
    rgba(212,175,55,0) 100%);
  animation:spin 1.6s linear infinite;
  filter:blur(2px);
  border-radius:50%;
}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.loadingText{
  color:#d4af37;
  font-weight:700;
  margin-top:12px;
  font-size:1.5rem;
  text-shadow:0 0 10px #d4af37;
}
</style>
</head>
<body>

<header>
  <h1>MYKUALAEXPRESS+</h1>
</header>

<!-- Loading Screen -->
<div id="loading" style="display:none;">
  <div class="loaderBadge">
    <div class="loaderShimmer"></div>
  </div>
  <div class="loadingText">MYKUALAEXPRESS+</div>
  <div style="margin-top:6px;font-size:12px;color:rgba(255,255,255,0.6);">Loading...</div>
</div>

<!-- 1️⃣ View Bookings -->
<div class="container" id="viewBookingsScreen" style="display:block;">
  <h2>View Your Bookings</h2>
  <input type="text" id="bookingInput" placeholder="Enter Booking Code (MYKE-XXXX)"/>
  <div style="display:flex; gap:10px;">
    <button id="searchBookingBtn" style="flex:1;">Search</button>
    <button id="cancelBookingBtn" style="flex:1;background:linear-gradient(90deg,#f33,#a00);color:#fff;">Cancel</button>
  </div>
  <div id="bookingDetails"></div>
</div>

<!-- 2️⃣ Scan Ticket -->
<div class="container" id="scanTicketScreen">
  <h2>Your Booking Code</h2>
  <p id="bookingCodeText" style="font-size:2rem;font-weight:700;text-align:center;margin:20px 0;"></p>
  <p id="checkinStatusText" style="text-align:center;font-weight:700;"></p>
  <p style="text-align:center;font-size:12px;color:rgba(255,255,255,0.7);margin-top:10px;">
    Copy this code and show to paste to view your tickets page. If you click button done, you can't see this code again. Any help go to DKTT
  </p>
  <button id="scanDoneBtn">Done</button>
</div>

<footer>
  © SkylinesTransit 2025
</footer>

<script>
// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyDcAq_rnJ3342lCpxalebddMFGDFUrypUg",
  authDomain:"aeris-data-smkmii.firebaseapp.com",
  projectId:"aeris-data-smkmii",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// SPA helper function
function showScreen(screenId){
  document.querySelectorAll('.container').forEach(c=>c.style.display='none');
  document.getElementById(screenId).style.display='block';
}

// Loading helper function
function showLoading(show){
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// Search Booking with shimmer loading
document.getElementById('searchBookingBtn').addEventListener('click', async ()=>{
  const code = document.getElementById('bookingInput').value.trim().toUpperCase();
  const bookingDetails = document.getElementById('bookingDetails');
  if(!code){ alert("Masukkan Booking Code!"); return; }
  showLoading(true);
  bookingDetails.innerHTML = '';

  setTimeout(async ()=>{
    try{
      const snapshot = await db.collection('Bookings').where('bookingCode','==',code).get();
      showLoading(false);

      if(snapshot.empty){
        bookingDetails.innerHTML = `<p>No booking found</p>`;
        return;
      }

      const data = snapshot.docs[0].data();
      const paymentText = data.paymentStatus ? "Payment Confirmed" : "Not Yet Confirmed";
      const checkinStatus = data.checkin === true;

      // Convert timestamp ke string
      let formattedDateTime = "";
      if(data.selectedCar.date && data.selectedCar.date.toDate){
        const dateObj = data.selectedCar.date.toDate();
        const yyyy = dateObj.getFullYear();
        const mm = String(dateObj.getMonth()+1).padStart(2,'0');
        const dd = String(dateObj.getDate()).padStart(2,'0');

        let hours = dateObj.getHours();
        const minutes = String(dateObj.getMinutes()).padStart(2,'0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const hh = String(hours).padStart(2,'0');

        formattedDateTime = `${yyyy}-${mm}-${dd} ${hh}:${minutes} ${ampm}`;
      }

      // Build HTML
      let html = `
        <p><strong>Passenger:</strong> ${data.userInfo.fullName}</p>
        <p><strong>IC:</strong> ${data.userInfo.ic}</p>
        <p><strong>Phone:</strong> ${data.userInfo.phone}</p>
        <p><strong>Email:</strong> ${data.userInfo.email}</p>
        <p><strong>Car:</strong> ${data.selectedCar.carModel} (${data.selectedCar.numberPlate})</p>
        <p><strong>Driver:</strong> ${data.selectedCar.driver}</p>
        <p><strong>From → To:</strong> ${data.selectedCar.from} → ${data.selectedCar.to}</p>
        <p><strong>Price:</strong> ${data.selectedCar.price}</p>
        <p><strong>Date & Time:</strong> ${formattedDateTime}</p>
        <p><strong>Payment Status:</strong> ${paymentText}</p>
        <p><strong>Booking Code:</strong> ${data.bookingCode}</p>
      `;

      if(data.paymentStatus){
        if(checkinStatus){
          html += `<p style="color:#0f0;font-weight:700;">Already Checked-In !</p>`;
        } else {
          html += `<p style="color:#f33;font-weight:700;">Not Checked-In</p>`;
          html += `<button onclick="showScanTicket('${data.bookingCode}')">Check-In</button>`;
        }
      }

      bookingDetails.innerHTML = html;

    }catch(err){
      showLoading(false);
      bookingDetails.innerHTML = `<p>Error fetching booking</p>`;
      console.error(err);
    }
  }, 1200);
});

// Cancel button redirect
document.getElementById('cancelBookingBtn').addEventListener('click', ()=>{
  window.location.href = "https://www.example.com"; // ganti dengan URL target
});

// Show Scan Ticket & handle check-in
async function showScanTicket(bookingCode){
  showScreen('scanTicketScreen');
  document.getElementById('bookingCodeText').textContent = bookingCode;

  const checkinTextEl = document.getElementById('checkinStatusText');
  try{
    const snapshot = await db.collection('Bookings').where('bookingCode','==',bookingCode).get();
    if(!snapshot.empty){
      const docRef = snapshot.docs[0].ref;
      const data = snapshot.docs[0].data();

      if(data.checkin === true){
        checkinTextEl.textContent = "Already Checked-In!";
        checkinTextEl.style.color = "#0f0";
      } else {
        await docRef.update({checkin:true});
        checkinTextEl.textContent = "Checked-In Successfully!";
        checkinTextEl.style.color = "#f33";
      }
    } else {
      checkinTextEl.textContent = "Booking not found!";
      checkinTextEl.style.color = "#f33";
    }
  } catch(err){
    console.error(err);
    checkinTextEl.textContent = "Error checking in!";
    checkinTextEl.style.color = "#f33";
  }
}

// Done button back to View Bookings
document.getElementById('scanDoneBtn').addEventListener('click', ()=>{
  window.location.href = "https://itshdfs.github.io/mykexplusapp/"; // ganti dengan URL target
});
</script>
</body>
</html>

